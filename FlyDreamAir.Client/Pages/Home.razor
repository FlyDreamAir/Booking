@page "/"
@using FlyDreamAir.Data.Model
@inject IJSRuntime JSRuntime
@inject BookingsService BookingsService

<PageTitle>Home</PageTitle>

<div class="m-2">
    <div class="m-5">
        <DeviceView>
            <Desktop>
                <MudImage Src="assets/plane.png" ObjectFit="@ObjectFit.Cover"
                          Style="max-width: 50%; margin-left: auto; margin-right: auto; display: block;" />
            </Desktop>
            <Mobile>
                <MudImage Src="assets/plane.png" ObjectFit="@ObjectFit.Cover"
                          Style="max-width: 100%; margin-left: auto; margin-right: auto; display: block;" />
            </Mobile>
        </DeviceView>
    </div>

    <DeviceView>
        <Desktop>
            <style>
                .FlyDreamAir-LocationSelect {
                    min-width: 20vw;
                    max-width: 25vw;
                }
                .FlyDreamAir-DateSelect {
                    min-width: 20vw;
                    max-width: 25vw;
                }
            </style>
        </Desktop>
        <Mobile>
            <style>
                @@media only screen and (max-width: 768px) {
                    .FlyDreamAir-LocationSelect {
                        min-width: 40vw;
                        max-width: 45vw;
                    }

                    .FlyDreamAir-DateSelect {
                        min-width: 90vw;
                        max-width: 100vw;
                    }
                }
            </style>
        </Mobile>
    </DeviceView>

    <MudHtmlForm Action="/Flights/Flights"
                 Method="@HtmlFormMethod.Get"
                 Context="form">
        <MudStack>
            @{
                RenderFragment<Airport> itemTemplate = (airport) =>
                    @<MudText>
                        <b>@airport.Id</b> - @airport.City, @airport.Country (@airport.Name)
                    </MudText>;

                RenderFragment fromSelect =
                    @<MudAutocomplete T="Airport"
                                      @bind-Value="_fromAirport"
                                      SearchFunc="(hint) => GetAirports(hint, _toAirport)"
                                      ToStringFunc="(a) => a?.Id"
                                      ShowProgressIndicator="true"
                                      CoerceText="true"
                                      Strict="false"
                                      Label="From"
                                      Required="true"
                                      RequiredError="Please enter your departure location."
                                      Adornment="@Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Outlined.PinDrop"
                                      Variant="@Variant.Outlined"
                                      Class="FlyDreamAir-LocationSelect"
                                      UserAttributes="@(new(){ {"name", "from"} })">
                        <ItemTemplate Context="airport">
                            @itemTemplate(airport)
                        </ItemTemplate>
                    </MudAutocomplete>;
                RenderFragment toSelect =
                    @<MudAutocomplete T="Airport"
                                      @bind-Value="_toAirport"
                                      SearchFunc="(hint) => GetAirports(hint, _fromAirport)"
                                      ToStringFunc="(a) => a?.Id"
                                      ShowProgressIndicator="true"
                                      CoerceText="true"
                                      Strict="false"
                                      Label="To"
                                      Required="true"
                                      RequiredError="Please enter your destination."
                                      Adornment="@Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Outlined.AirplanemodeActive"
                                      Variant="@Variant.Outlined"
                                      Class="FlyDreamAir-LocationSelect"
                                      UserAttributes="@(new(){ {"name", "to"} })">
                        <ItemTemplate Context="airport">
                            @itemTemplate(airport)
                        </ItemTemplate>
                    </MudAutocomplete>;
                RenderFragment datePicker =
                    @<MudDatePicker @bind-Date="_date"
                                    Placeholder="Select date"
                                    DateFormat="dd/MM/yyyy"
                                    MinDate="DateTime.Today"
                                    Adornment="@Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Outlined.CalendarToday"
                                    Required="true"
                                    RequiredError="Please enter your departure date."
                                    Variant="@Variant.Outlined"
                                    Class="FlyDreamAir-DateSelect"
                                    TransformOrigin="@Origin.CenterLeft" />;
            }
            <DeviceView>
                <Desktop>
                    <MudStack Row="true" Justify="@Justify.SpaceEvenly"
                              Style="max-width: 75%; margin-left: auto; margin-right: auto;">
                        @fromSelect
                        @toSelect
                        @datePicker
                    </MudStack>
                </Desktop>
                <Mobile>
                    <MudStack>
                        <MudStack Row="true">
                            @fromSelect
                            @toSelect
                        </MudStack>
                        @datePicker
                    </MudStack>
                </Mobile>
            </DeviceView>
            <MudStack Row="true" Justify="@Justify.Center">
                <MudButton Variant="@Variant.Filled"
                           Color="@Color.Primary"
                           Size="@Size.Large"
                           Style="border-radius: 100px;"
                           OnClick="form.Submit">
                    Search
                </MudButton>
            </MudStack>
            <!-- Shadow input element to convert to the correct format. -->
            <input name="date"
                   value="@(_date?
                            .ToString("yyyy-MM-dd",
                                System.Globalization.CultureInfo.InvariantCulture))"
                   hidden />
        </MudStack>
    </MudHtmlForm>
</div>

@code {
    private List<Airport>? _airports = null;
    private Airport? _fromAirport;
    private Airport? _toAirport;
    private DateTime? _date;

    private async Task<IEnumerable<Airport>> GetAirports(string? hint, Airport? exclude)
    {
        _airports ??= await BookingsService.GetAirportsAsync().ToListAsync();
        hint ??= "";

        return _airports.Where(a => a.Id != exclude?.Id)
            .Where(a =>
                a.Id.Equals(hint, StringComparison.InvariantCultureIgnoreCase)
                || a.City.Contains(hint, StringComparison.InvariantCultureIgnoreCase)
                || a.Country.Contains(hint, StringComparison.InvariantCultureIgnoreCase)
                || a.Name.Contains(hint, StringComparison.InvariantCultureIgnoreCase)
            );
    }
}
